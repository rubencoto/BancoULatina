<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GestiÃ³n de PrÃ©stamos - Banco U Latina</title>
  <link rel="stylesheet" href="/css/estilos.css"/>
</head>
<body>
  <header class="header">
    <div class="container">
      <h1>ğŸ’° GestiÃ³n de PrÃ©stamos</h1>
      <p>Administra y supervisa todos los prÃ©stamos del banco</p>
    </div>
  </header>

  <nav>
    <div class="container">
      <a href="/trabajador/inicio">ğŸ  Inicio</a>
      <a href="/trabajador/clientes">ğŸ‘¥ Clientes</a>
      <a href="/trabajador/prestamos" class="active">ğŸ’° PrÃ©stamos</a>
      <a href="/trabajador/solicitudes">ğŸ“„ Solicitudes</a>
      <a href="/trabajador/tickets">ğŸ« Tickets</a>
    </div>
  </nav>

  <div class="container">
    <!-- NotificaciÃ³n de actualizaciÃ³n -->
    <div th:if="${param.actualizado}" class="alert alert-success">
      âœ… Estado del prÃ©stamo actualizado exitosamente.
    </div>

    <!-- EstadÃ­sticas de PrÃ©stamos -->
    <div class="stats-grid">
      <div class="stat-card">
        <h3>Total PrÃ©stamos</h3>
        <p class="stat-value" th:text="${#lists.size(prestamos)}">0</p>
        <span class="stat-label">PrÃ©stamos registrados</span>
      </div>
      <div class="stat-card active">
        <h3>PrÃ©stamos Activos</h3>
        <p class="stat-value" th:text="${#lists.size(prestamos.?[estado.name() == 'ACTIVO'])}">0</p>
        <span class="stat-label">En curso</span>
      </div>
      <div class="stat-card pending">
        <h3>Pendientes Desembolso</h3>
        <p class="stat-value" th:text="${#lists.size(prestamos.?[estado.name() == 'PENDIENTE_DESEMBOLSO'])}">0</p>
        <span class="stat-label">Por activar</span>
      </div>
      <div class="stat-card closed">
        <h3>PrÃ©stamos Cerrados</h3>
        <p class="stat-value" th:text="${#lists.size(prestamos.?[estado.name() == 'CERRADO'])}">0</p>
        <span class="stat-label">Finalizados</span>
      </div>
    </div>

    <!-- Filtros y BÃºsqueda -->
    <div class="card">
      <div class="card-header">
        <h3>ğŸ” Filtros</h3>
      </div>

      <form method="get" th:action="@{/trabajador/prestamos}" class="filter-form">
        <div class="filter-group">
          <label for="estado">ğŸ“Š Estado del PrÃ©stamo</label>
          <select name="estado" id="estado">
            <option th:selected="${estado==null}" value="">ğŸ” Todos los estados</option>
            <option th:selected="${estado != null and estado.name() == 'PENDIENTE_DESEMBOLSO'}" value="PENDIENTE_DESEMBOLSO">â³ Pendiente Desembolso</option>
            <option th:selected="${estado != null and estado.name() == 'ACTIVO'}" value="ACTIVO">âœ… Activo</option>
            <option th:selected="${estado != null and estado.name() == 'CERRADO'}" value="CERRADO">ğŸ”’ Cerrado</option>
            <option th:selected="${estado != null and estado.name() == 'INCUMPLIDO'}" value="INCUMPLIDO">âš ï¸ Incumplido</option>
          </select>
        </div>

        <div class="filter-actions">
          <button type="submit" class="btn btn-primary">ğŸ” Filtrar</button>
          <a href="/trabajador/prestamos" class="btn btn-outline">ğŸ”„ Limpiar</a>
        </div>
      </form>
    </div>

    <!-- Lista de PrÃ©stamos -->
    <div class="card">
      <div class="card-header">
        <h3>ğŸ“‹ Lista de PrÃ©stamos</h3>
        <span class="badge" th:text="${#lists.size(prestamos)} + ' prÃ©stamos'">0 prÃ©stamos</span>
      </div>

      <div th:if="${#lists.isEmpty(prestamos)}" class="empty-state">
        <div class="empty-icon">ğŸ’°</div>
        <h3>No se encontraron prÃ©stamos</h3>
        <p>No hay prÃ©stamos que coincidan con los filtros seleccionados</p>
        <a href="/trabajador/prestamos" class="btn btn-secondary">Ver Todos</a>
      </div>

      <div th:if="${not #lists.isEmpty(prestamos)}" class="loans-table-container">
        <table class="modern-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>ğŸ‘¤ Cliente</th>
              <th>ğŸ’° Monto</th>
              <th>ğŸ“Š Tasa</th>
              <th>â±ï¸ Plazo</th>
              <th>ğŸ“… Fechas</th>
              <th>ğŸ’³ Saldo</th>
              <th>ğŸ“Š Estado</th>
              <th>âš™ï¸ Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="p : ${prestamos}" th:classappend="${p.estado.name().toLowerCase()}">
              <td>
                <span class="loan-id">#<span th:text="${p.id}">001</span></span>
              </td>
              <td>
                <div class="client-info">
                  <span class="client-name" th:text="${p.cliente.nombreCompleto}">Juan PÃ©rez</span>
                  <small class="client-email" th:text="${p.cliente.correo}">juan@email.com</small>
                </div>
              </td>
              <td>
                <span class="amount" th:text="${#numbers.formatDecimal(p.montoPrincipal, 0, 'COMMA', 0, 'POINT')} + ' CRC'">â‚¡1,000,000</span>
              </td>
              <td>
                <span class="rate" th:text="${#numbers.formatDecimal(p.tasaAnual*100,1,2)} + '%'">12.00%</span>
              </td>
              <td>
                <span class="term" th:text="${p.plazoMeses} + ' meses'">24 meses</span>
              </td>
              <td>
                <div class="date-info">
                  <div th:if="${p.fechaInicio != null}">
                    <small>Inicio:</small>
                    <span th:text="${#temporals.format(p.fechaInicio, 'dd/MM/yyyy')}">01/01/2024</span>
                  </div>
                  <div th:if="${p.fechaFin != null}">
                    <small>Fin:</small>
                    <span th:text="${#temporals.format(p.fechaFin, 'dd/MM/yyyy')}">01/01/2026</span>
                  </div>
                  <div th:if="${p.fechaInicio == null}">
                    <small class="text-muted">Sin fechas</small>
                  </div>
                </div>
              </td>
              <td>
                <span class="balance" th:text="${#numbers.formatDecimal(p.saldoPendiente, 0, 'COMMA', 0, 'POINT')} + ' CRC'">â‚¡800,000</span>
                <div th:if="${p.estado.name() == 'ACTIVO'}" class="progress-mini">
                  <div class="progress-bar-mini">
                    <div class="progress-fill-mini" th:style="'width: ' + ${(p.montoPrincipal - p.saldoPendiente) / p.montoPrincipal * 100} + '%'"></div>
                  </div>
                  <small th:text="${#numbers.formatDecimal((p.montoPrincipal - p.saldoPendiente) / p.montoPrincipal * 100, 1, 0)} + '% pagado'">20% pagado</small>
                </div>
              </td>
              <td>
                <span class="status-badge" th:text="${p.estado}" th:classappend="${p.estado.name().toLowerCase()}">ACTIVO</span>
              </td>
              <td>
                <div class="action-buttons">
                  <form th:action="@{'/trabajador/prestamos/' + ${p.id} + '/estado'}"
                        method="post"
                        style="display:inline"
                        th:if="${p.estado.name() == 'PENDIENTE_DESEMBOLSO'}">
                    <input type="hidden" name="estado" value="ACTIVO">
                    <button type="submit" class="btn btn-sm btn-success" title="Activar prÃ©stamo">
                      âœ… Activar
                    </button>
                  </form>

                  <form th:action="@{'/trabajador/prestamos/' + ${p.id} + '/estado'}"
                        method="post"
                        style="display:inline"
                        th:if="${p.estado.name() == 'ACTIVO'}">
                    <input type="hidden" name="estado" value="CERRADO">
                    <button type="submit" class="btn btn-sm btn-outline" title="Cerrar prÃ©stamo">
                      ğŸ”’ Cerrar
                    </button>
                  </form>

                  <form th:action="@{'/trabajador/prestamos/' + ${p.id} + '/estado'}"
                        method="post"
                        style="display:inline"
                        th:if="${p.estado.name() == 'ACTIVO'}">
                    <input type="hidden" name="estado" value="INCUMPLIDO">
                    <button type="submit" class="btn btn-sm btn-danger" title="Marcar como incumplido" onclick="return confirm('Â¿EstÃ¡s seguro de marcar este prÃ©stamo como incumplido?')">
                      âš ï¸ Incumplido
                    </button>
                  </form>

                  <a th:href="@{'/trabajador/cliente/' + ${p.cliente.id}}" class="btn btn-sm btn-outline" title="Ver detalles del cliente">
                    ğŸ‘¤ Ver Cliente
                  </a>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Acciones RÃ¡pidas -->
    <div class="quick-actions">
      <h3>ğŸš€ Acciones RÃ¡pidas</h3>
      <div class="actions-grid">
        <a href="/trabajador/solicitudes" class="action-card">
          <div class="action-icon">ğŸ“„</div>
          <h4>Ver Solicitudes</h4>
          <p>Revisar nuevas solicitudes de prÃ©stamos</p>
        </a>
        <a href="/trabajador/clientes" class="action-card">
          <div class="action-icon">ğŸ‘¥</div>
          <h4>Buscar Clientes</h4>
          <p>Buscar informaciÃ³n de clientes</p>
        </a>
        <a href="/trabajador/tickets" class="action-card">
          <div class="action-icon">ğŸ«</div>
          <h4>Tickets de Soporte</h4>
          <p>Atender consultas de clientes</p>
        </a>
      </div>
    </div>
  </div>

  <script>
    // Animaciones para las filas de la tabla
    document.addEventListener('DOMContentLoaded', function() {
      const rows = document.querySelectorAll('tbody tr');
      rows.forEach((row, index) => {
        row.style.animationDelay = (index * 0.05) + 's';
        row.classList.add('fade-in');
      });
    });

    // ConfirmaciÃ³n para acciones crÃ­ticas
    document.querySelectorAll('.btn-danger').forEach(button => {
      button.addEventListener('click', function(e) {
        if (!confirm('Â¿EstÃ¡s seguro de realizar esta acciÃ³n?')) {
          e.preventDefault();
        }
      });
    });
  </script>
</body>
</html>
